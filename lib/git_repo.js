// Generated by CoffeeScript 1.4.0
var Findit, GitRepo, GitSupport, nodefn, sequence;

GitSupport = require('./git_support');

Findit = require('findit');

sequence = require('when/sequence');

nodefn = require('when/node/function');

GitRepo = (function() {

  function GitRepo() {}

  GitRepo.manager = function() {
    return 'none';
  };

  GitRepo.search = function(rootRepoDir, Plugin, masterDefer, callback) {
    var find, found, manager, uniq;
    find = Findit.find(rootRepoDir);
    uniq = {};
    found = [];
    manager = this.manager();
    find.on('directory', function(dir, stat) {
      var match;
      if (match = dir.match(/(.*)\/.git\//)) {
        if (typeof uniq[match[1]] !== 'undefined') {
          return;
        }
        uniq[match[1]] = 1;
        masterDefer.notify.event.good('found repo', "" + match[1] + "/.git");
        return found.push(match[1]);
      }
    });
    return find.on('end', function() {
      var failed, path, paths, seq, success, tasks;
      seq = 0;
      paths = [];
      tasks = sequence((function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = found.length; _i < _len; _i++) {
          path = found[_i];
          paths.unshift(path);
          _results.push(function() {
            return nodefn.call(Plugin.Package.init, paths.pop(), seq++, manager, masterDefer);
          });
        }
        return _results;
      })());
      return tasks.then(success = function(repos) {
        return callback(null, repos);
      }, failed = function(error) {
        return callback(error);
      });
    });
  };

  GitRepo.init = function(repoDir, seq, manager, masterDefer, callback) {
    var failed, success, tasks;
    tasks = sequence([
      function() {
        return nodefn.call(GitSupport.getOrigin, repoDir);
      }, function() {
        return nodefn.call(GitSupport.getHeadRef, repoDir);
      }, function() {
        return nodefn.call(GitSupport.getHeadVersion, repoDir);
      }
    ]);
    return tasks.then(success = function(results) {
      return callback(null, {
        root: seq === 0,
        path: repoDir,
        manager: manager,
        origin: results[0],
        branch: results[1],
        ref: results[2]
      });
    }, failed = function(error) {
      return callback(error);
    });
  };

  return GitRepo;

})();

module.exports = GitRepo;
